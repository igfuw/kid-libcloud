language: cpp
os: 
  - linux
compiler:
  - gcc
addons:
  apt:
    packages:
      - g++-6
      - boost1.61
      - gfortran
      - nco
      - libnetcdfc7
      - libnetcdf-dev 
      - python-numpy 
      - python-cffi 
      - libblitz0-dev 
      - python-pytest
      - libthrust-dev
    sources: &sources
      - sourceline: 'ppa:rakhimov/boost'
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty-4.0

notifications:
  email: false

before_install:
# to avoid python lib/interpreter mismatch; https://github.com/travis-ci/travis-ci/issues/5326
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then export PATH=$(echo $PATH | tr ':' "\n" | sed '/\/opt\/python/d' | tr "\n" ":" | sed "s|::|:|g"); fi
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo add-apt-repository "deb http://us.archive.ubuntu.com/ubuntu/ trusty main universe multiverse restricted"; fi
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then export apt_get_install="apt-get install -t trusty --no-install-recommends -y"; fi
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get update; fi

  # locally installed stuff comes first
  - export PATH=/usr/local/bin:$PATH

install:
#compiler
  - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'g++'     ]]; then export CC=gcc-6; fi
  - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'g++'     ]]; then export CXX=g++-6; fi

# cmake 
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then wget https://github.com/Kitware/CMake/releases/download/v3.13.2/cmake-3.13.2-Linux-x86_64.sh; fi
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo sh cmake-3.13.2-Linux-x86_64.sh --prefix=/usr/local --exclude-subdir; fi

# recent boost is installed using addons functionality

#libcloudphxx dependencies
#  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo $apt_get_install libblitz0-dev python-numpy python-scipy libthrust-dev python-pytest; fi

# newest thrust
  - git clone --depth=1 git://github.com/thrust/thrust.git;
  - sudo ln -s `pwd`/thrust/thrust /usr/local/include/thrust;

script:
  # install libcloudphxx in RelWithDebInfo mode
  - cd ..
  - git clone --single-branch --branch kida-1d --depth=1 git://github.com/igfuw/libcloudphxx.git
  - cd libcloudphxx
  - mkdir build
  - cd build
  - cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
  - make
  - sudo make install
  - cd ../..

  - cd kid-libcloud
  - gcc -fPIC -shared ptrutil.c -o ptrutil.so
  - tar xvzf kid_a_setup-20180125.tar.gz
  - cp mphys_libcloud_lgr.f90 kid_a_setup/src/mphys_libcloud_lgr.f90 
  - cp kida_icmwSC_2D_libcloud_lgr.nml kid_a_setup/namelists/
  - cp kida_icmw1D_libcloud_lgr.nml kid_a_setup/namelists/
  - cp ICMW_SC_input.nml kid_a_setup/namelists/
  - cd kid_a_setup
  - patch -p1 < ../kid_a_setup_20180125.diff

  # run 1D case with w=3m/s
  - make SHELL=/bin/bash CASE=1D COMPILER=gfortran NCPATH=/usr all
  - FILEOUT=output LD_LIBRARY_PATH=..:bin LD_PRELOAD=ptrutil.so python ../kid_1D.py --backend=OpenMP
  # test the results
  - cd output
  - ncdiff -v liquid_water_path 1D_out.nc ../../refdata/w3_N50_NORAIN.nc diff.nc
  # check if the difference is small enough
  - ncap2 -A -s "diff_flag=liquid_water_path<1e-3 && liquid_water_path>-1e-3" diff.nc
  - ncra diff.nc diff_mean.nc
  - ncks --trd -V -v diff_flag -C -H diff_mean.nc  | grep -q '1'
  - cd ..

  # run 1D case with w=2m/s
  - sed -i 's/wctrl(1)=3/wctrl(1)=2/g' namelists/kida_icmw1D_libcloud_lgr.nml
  - FILEOUT=output LD_LIBRARY_PATH=..:bin LD_PRELOAD=ptrutil.so python ../kid_1d.py --backend=OpenMP
  # test the results
  - cd output
  - ncdiff -v liquid_water_path 1D_out.nc ../../refdata/w2_N50_NORAIN.nc diff.nc
  # check if the difference is small enough
  - ncap2 -A -s "diff_flag=liquid_water_path<1e-3 && liquid_water_path>-1e-3" diff.nc
  - ncra diff.nc diff_mean.nc
  - ncks --trd -V -v diff_flag -C -H diff_mean.nc  | grep -q '0'
  - cd ..
